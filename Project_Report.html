<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.24">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mark Deng">
<meta name="author" content="Tess Vu">
<meta name="dcterms.date" content="2025-12-03">

<title>Hot City, Heated Calls</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="Project_Report_files/libs/clipboard/clipboard.min.js"></script>
<script src="Project_Report_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="Project_Report_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="Project_Report_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="Project_Report_files/libs/quarto-html/popper.min.js"></script>
<script src="Project_Report_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Project_Report_files/libs/quarto-html/anchor.min.js"></script>
<link href="Project_Report_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Project_Report_files/libs/quarto-html/quarto-syntax-highlighting-dc55a5b9e770e841cd82e46aadbfb9b0.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Project_Report_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Project_Report_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Project_Report_files/libs/bootstrap/bootstrap-9e3ffae467580fdb927a41352e75a2e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Hot City, Heated Calls</h1>
<p class="subtitle lead">Understanding How Urban Features Affect Quality of Life Under Different Heat Conditions Using New York City’s 311 and SHAP</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-contents">
             <p>Mark Deng </p>
             <p>Tess Vu </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 3, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>1. INTRODUCTION</h1>
<section id="research-background" class="level2">
<h2 class="anchored" data-anchor-id="research-background">1.1. Research Background</h2>
<p>Extreme heat weather is one of the deadliest environmental hazards in the United States, the heat extreme heat events have significant negative impacts on urban public health and urban sustainable development. In dense, urban metropolitan cities like New York, extreme heat interacts with not just the built environment and local infrastructure conditions, but also the socioeconomic climate—extreme heat acts as one of the many architects shaping where service disruptions, complaints, and other surrounding stressors occur, degrading quality-of-life (QoL) for urban residents.</p>
<p>Within the context of this degradation is New York City’s 311 service, a complaint system that accepts reports via calls, emails, and website submissions that can reflect heat induced QoL behavior; it is a granular, real-time lens that provides understanding of how heat-related aggravation and other aspects can translate into observable, negative resident sentiment. This project in particular seeks to connect extreme heat versus normal heat weeks with environmental factors, socioeconomic conditions, and urban morphology to potentially explain QoL issues by different factors and their different performance during hotter periods.</p>
<p>In this regard, the project is built upon geospatial data science techniques for modeling weekly QoL outcomes in extreme heat and normal heat conditions, as proxied by selected 311 report categories, using ordinary least squares (OLS) regression modeling as a baseline followed by modern machine learning (ML) models, and SHapley Additive exPlanations (SHAP) method to interpret.</p>
</section>
<section id="research-gap" class="level2">
<h2 class="anchored" data-anchor-id="research-gap">1.2. Research Gap</h2>
<p>A substantial body of literature has established the correlation between rising temperatures and increased frequency of 311 service requests, specifically regarding noise, energy, and water consumption (Harlan et al., 2006; Hsu et al., 2021). And some other urban research also identified how different socioeconomic, environmental, and urban built metrics patterns shape the spatial heterogeneity of 311 calls (Uejio et al., 2010). However, fewer studies connect them and investigate how the impact of these factors on QoF performance shifts when the thermal environment crosses into extreme thresholds.</p>
<p>Transitional approaches like OLS in 311 analysis generally struggle to capture the non-linear behaviors of human-environment interactions. While machine learning offers improved predictive power, (Kontokosta &amp; Tull, 2017) it generally lacks interpretability. So, by integrating SHAP approach to compare extreme versus normal heat weeks, this study addresses a critical gap, where it takes a step further from simple prediction to interpret and explain socioeconomic, environmental, and urban built drivers under two different heat regimes, of which is explained in detail in section 2. (Lundberg &amp; Lee, 2017)</p>
</section>
<section id="research-objective" class="level2">
<h2 class="anchored" data-anchor-id="research-objective">1.3. Research Objective</h2>
<p>With the research gap’s context, this study asks: how do environmental, socioeconomic, and urban morphology factors influence the QoL in New York City, defined as QoL-related 311 report rate per capita, during extreme heat weeks versus normal heat weeks?</p>
<p>Heat-related academic literature suggests that discomfort rises with temperature, so it is hypothesized that the QoL rate per capita will align with those findings. However, the objective of this research is to produce SHAP model values that can help reveal the drivers of QoL complaints in New York City.</p>
</section>
</section>
<section id="data-and-methods" class="level1">
<h1>2. DATA and METHODS</h1>
<section id="study-area-and-period" class="level2">
<h2 class="anchored" data-anchor-id="study-area-and-period">2.1. Study Area and Period</h2>
<p>The study area is based in New York City with spatial resolution at the census tract level, with these observations during summer 2025, defined as the beginning of June through August 23rd at a weekly temporal resolution. The last week of August was not used due to recent weather data only recorded up to the 24th, therefore not providing a whole week, so it was removed from the study.</p>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">2.2. Data Preparation</h2>
<section id="heat-data" class="level3">
<h3 class="anchored" data-anchor-id="heat-data">Heat Data</h3>
<p>The subsequent removal of August’s last week provided a total of 12 weeks in summer 2025, where extreme heat weeks were defined as at least two extreme heat days within a week with a temperature cutoff threshold at 93°F using the John F. Kennedy (JFK) weather station located at Philadelphia’s international airport. This threshold was determined according to a climatological baseline from 1981 through 2010 daily max temperature with a 95th percentile, and this split the observations into two needed regimes: 17 extreme heat days and 71 normal heat days, providing 5 extreme heat weeks and 7 normal heat weeks. Data was directly downloaded from the National Oceanic and Atmospheric Administration (NOAA).</p>
</section>
<section id="socioeconomic-data" class="level3">
<h3 class="anchored" data-anchor-id="socioeconomic-data">Socioeconomic Data</h3>
<p>Socioeconomic data was derived from the United States Census, specifically the most recent 5-year American Community Survey (ACS) in 2023. Python’s pyCensus module provided easy access to filter the data down to main investigative, derived variables in the final table:</p>
<ul>
<li>Percent Bachelor’s or More (B15003_022E / B15003_001E)
<ul>
<li>Bachelor’s or More / Education Total</li>
</ul></li>
<li>Percent Renters (B25003_003E / B25003_001E)
<ul>
<li>Renter Count / Household Total</li>
</ul></li>
<li>Percent Limited English Speakers (B16005_007E / B16005_001E)
<ul>
<li>Limited English Speaker Count / Household Total</li>
</ul></li>
<li>Median Household Income (B19013_001E)</li>
<li>Poverty Rate (B17001_002E / B17001_001E)
<ul>
<li>Poverty Count / Total Whom Poverty Status is Recorded</li>
</ul></li>
<li>Percent Non-White (1 - B02001_002E / B01003_001E)
<ul>
<li>(1 - White Count / Total Population)</li>
</ul></li>
</ul>
<p>Justifications for these variables highlight socioeconomic issues and how heat-related issues disproportionately affect different communities as well as how different communities interact with public services like New York City’s 311. Educated and higher-income individuals may know how to navigate what their cities offer, limited English speakers may have more barriers accessing 311 services, renters may face more infrastructural issues compared to owners.</p>
</section>
<section id="urban-environmental-data" class="level3">
<h3 class="anchored" data-anchor-id="urban-environmental-data">Urban Environmental Data</h3>
<p>Environmental urban data were derived from Landsat &amp; LULC raster calculations and OSM water data, specifically scenes within the same study timeline, with the manipulation and computation done through ArcGIS Pro and Python. However, land-cover land-use (LULC) data was a static raster from 2024.</p>
<ul>
<li>LULC Raster
<ul>
<li>Percent Tree Canopy</li>
<li>Percent Impervious Surface</li>
</ul></li>
<li>Landsat Raster
<ul>
<li>Normalized Difference Vegetation Index (NDVI)</li>
</ul></li>
<li>NYC Open Data: water shp
<ul>
<li>Water Cover Ratio</li>
</ul></li>
</ul>
</section>
<section id="urban-built-and-spatial-data" class="level3">
<h3 class="anchored" data-anchor-id="urban-built-and-spatial-data">Urban Built and Spatial Data</h3>
<p>Building data came from NYC open data of building footprint shp file with height field. Spatial data included deriving spatial features from Python’s osmnx module to calculate points-of-interest (POI) density utilizing a 500-meter buffer and mean Euclidean distance to the nearest subway of census tract centroids.</p>
<ul>
<li>NYC Open Data: buildings shp
<ul>
<li>Weighted Average Height of Buildings (AH)</li>
<li>Building Density (BD)</li>
</ul></li>
</ul>
<p>POIs were determined as everyday main amenities, shops, leisure, and public transport categories in OpenStreet Maps (OSM) yielding 21,309 points, and are as follows:</p>
<ul>
<li>Amenity
<ul>
<li>library</li>
<li>community_centre</li>
<li>social_facility</li>
<li>bus_station</li>
<li>bar</li>
<li>restaurant</li>
<li>fast_food</li>
<li>toilets</li>
<li>hospital</li>
<li>clinic</li>
<li>pharmacy</li>
</ul></li>
<li>Shop
<ul>
<li>convenience</li>
<li>supermarket</li>
<li>alcohol</li>
<li>deli</li>
</ul></li>
<li>Leisure
<ul>
<li>park</li>
</ul></li>
<li>Public Transport
<ul>
<li>station</li>
</ul></li>
</ul>
<p>Justification for these variables are that quantifiable metrics of greenery such as tree canopy and NDVI, as well as water coverage, could help explore the relationship between their roles in heat mitigation and alleviating air pollution within cities, and how they could potentially affect QoL requests as a byproduct. In addition, the impervious surface can suggest high heat absorption throughout the city at high percentages, and this is the same case with the building heights and densities. While many of these environmental and urban forms may be multicollinear, the goal is striving for interpretation rather than maximizing prediction, and this helps to explore the different properties of a city.</p>
</section>
</section>
<section id="ols-regression-model" class="level2">
<h2 class="anchored" data-anchor-id="ols-regression-model">2.3. OLS Regression Model</h2>
<p>OLS regression was used as the foundational statistical model in this study because it provides an interpretable, baseline framework for understanding the linear associations between environmental, socioeconomic, urban morphology, and spatial accessibility characteristics and the dependent variable of heat-related QoL 311 complaints per capita.</p>
<p>Separate cross-sectional OLS models were estimated for extreme heat weeks defined as those with at least two extreme heat days, and normal heat weeks defined as those with less than two extreme heat days, with each of the 2,225 observations representing a census tract by week.</p>
<p>Predictors were structured into three conceptual categories, which were added incrementally to assess the added explanatory value of each predictor block: Environmental Predictors, Socioeconomic Predictors, and Urban Morphology Predictors.</p>
<p><strong>Urban Environmental Features:</strong> NDVI, percent tree canopy, percent impervious surface, and water cover ratio.</p>
<p><strong>Urban Socioeconomic Features:</strong> Median income, poverty rate, percent renters, percent limited English, percent bachelor’s or more, and percent non-white.</p>
<p><strong>Urban Built and Spatial Features:</strong> Average building height, building density, distance to the nearest subway station, and 500-meter buffer POI density.</p>
<p>OLS provides a transparent estimation of how predictors correlate with QoL complaint rates, and coefficients can be directly interpreted and compared across extreme versus normal heat conditions, serving as an important reference model before introducing nonlinear ML approaches with Random Forest. So, given the behavioral nature of 311 complaint reporting and the noisy, high-frequency variability of QoL calls, relatively low R² values are expected in this domain, consistent with existing literature on 311 data, urban complaints, and human-environment interactions.</p>
</section>
<section id="ml-model-and-shap" class="level2">
<h2 class="anchored" data-anchor-id="ml-model-and-shap">2.4. ML Model and SHAP</h2>
<p>Stepping further to understanding the relationships between QoL and urban dynamics under different heat conditions, to complement the OLS framework, a nonlinear ML model was used to test whether environmental, socioeconomic, and urban predictors collectively produce stronger predictive power for QoL rates per capita during extreme and normal heat weeks.</p>
<p>In the case of this study RF, is stable on moderate-size datasets and can handle high multicollinearity and correlated predictors like this study’s without requiring regularization. In addition, it is less sensitive to hyperparameter tuning and is capable of modeling nonlinear relationships and threshold behaviors associated with heat stress, as it is a popular ML model used in the environmental exposure, health, and urban prediction literature.</p>
<p>Like the OLS model, the RF models were trained in the extreme heat weeks and normal heat weeks with the same predictor groups for direct comparison. Partitioning the tracts into an 80% train set and 20% test set, then a 3-fold Grid Search cross-validation was implemented to optimize the hyperparameters. The final performance metrics are based on test set.</p>
<p>While OLS is useful for interpretation, extreme heat effects on QoL likely possess nonlinearity, interactions between the built environment and socioeconomic vulnerability, among others, and RF accommodates to these unique idiosyncracies, capturing behavioral and nonlinear dynamics that OLS falls short on.</p>
<p>Finally, SHAP method was used to interpret the Random Forest results and quantify the contribution of each predictor to the predicted QoL complaint rate per capita. This particular methodology is well-suited for urban and environmental modeling because it can especially decompose predictions into additive contributions from each predictor, providing a measure of global importance and local explanations, so this makes the two regimes of extreme heat weeks versus normal heat weeks comparable.</p>
<p>With this, SHAP allows identification of which environmental, socioeconomic, or urban factors become more influential during extreme heat, and whether predictors behave differently under high heat versus normal heat conditions. And further use SHAP plots, we can discover the non-linear relationship between features and targets.</p>
</section>
</section>
<section id="results" class="level1">
<h1>3. RESULTS</h1>
<section id="exploratory-data-analysis" class="level2">
<h2 class="anchored" data-anchor-id="exploratory-data-analysis">3.1. Exploratory Data Analysis</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/target_variable_histogram.png" class="img-fluid figure-img"></p>
<figcaption><em>Target Variable Histogram</em></figcaption>
</figure>
</div>
<p>Histograms reveal leftward shift in heat week call distribution relative to normal weeks, evidenced by both mean and median decreases. This is a slight call reduction during extreme heat periods, conflicting with the main hypothesis. This may likely be due to behavioral shifts during extremes versus normals. While the 311 calls were selected based on their connections to heat and heightened aggravation with high temperatures, certain complaints like “banging” or “loud music” <em>could</em> decrease because individuals may want to insulate themselves indoors with AC, reducing audible and visible perceptions to outdoor or even sanitation issues.</p>
<p>Both distributions have pronounced positive skewness with long right tails extending beyond 15 calls per 1,000 population. However, heat week distribution per capita has more extreme outliers and higher variability, suggesting certain tracts experience disproportionate surges in QoL complaints during heat waves (about 852 tracts, or 38.3% of tracts have higher calls during heat weeks). These outlier tracts warrant individual investigation as they may be commercial districts with transient populations inflating per-capita rates, neighborhoods with vulnerable populations, areas with heightened civic engagement and 311 awareness, or tracts with potential data quality issues.</p>
<p>The great overlap between distributions suggests most tracts maintain relatively stable complaint rates regardless of heat conditions. However, some tracts do show meaningful elevation during heat weeks, highlighting importance of identifying characteristics that predict heat sensitivity rather than assuming universal heat response.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/environment_histogram.png" class="img-fluid figure-img"></p>
<figcaption><em>Environmental Predictors Histogram</em></figcaption>
</figure>
</div>
<p><strong>PCT_TREE_CANOPY:</strong> Tree canopy may be a powerful discriminator among neighborhood types as most tracts have very little canopy as opposed to others given the low mean and median yet high maximum.</p>
<p><strong>NDVI:</strong> Seemingly shows a similar distribution to PCT_TREE_CANOPY.</p>
<p><strong>WCR:</strong> Expectedly very low due to the urbanity of NYC unless tracts are bordering water bodies.</p>
<p><strong>PCT_IMPERVIOUS:</strong> High percentage is expected due to the built density of metropolitan cities.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/socioeconomic_histogram.png" class="img-fluid figure-img"></p>
<figcaption><em>Socioeconomic Predictors Histogram</em></figcaption>
</figure>
</div>
<p><strong>PCT_BACHELORS_PLUS:</strong> Over 30% of individuals attained high education, which also affects awareness and use of city services like 311. Again, high standard deviation indicates unequal distribution of education.</p>
<p><strong>PCT_RENTERS:</strong> Expected high values due to NYC being a renter-dominant city. This means a lot of renants may experience infrastructural issues outside of their immediate control, as safety and building regulation responsibilities fall on the landlord.</p>
<p><strong>PCT_LIMITED_ENGLISH:</strong> Very high skew shows that individuals who speak limited English are geographically stratified in different parts of NYC. This reflects a significant barrier to accessing 311 services.</p>
<p><strong>MEDIAN_INCOME:</strong>: After removing placeholder values, income distribution reveals NYC’s stark economic geography. Standard deviation exceeds the mean, indicating heavily skewed distribution, which unsurprisingly reflects extreme wealth inequality across census tracts.</p>
<p><strong>POVERTY_RATE:</strong> High right skew and a 100% max indicate concentrated poverty in certain neighborhoods.</p>
<p><strong>PCT_NON_WHITE:</strong> Racial composition reflects NYC’s diversity, but high variability indicates persistent residential segregation patterns that could interact with target variables.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/urban_histogram.png" class="img-fluid figure-img"></p>
<figcaption><em>Urban Form Predictors Histogram</em></figcaption>
</figure>
</div>
<p><strong>BD:</strong> Most tracts have low-to-moderate building coverage with some ultra-dense commercial/residential cores.</p>
<p><strong>AH:</strong> Building heights have great skew and range, so there’s significant vertical variability in NYC, likely reflecting skyscraper districts in the central core and mid- to low-rise as the geography eases out into the periphery.</p>
<p><strong>POI_500M_DENSITY:</strong> Amenities are expectedly highly clustered, likely in denser commercial / business and residential areas.</p>
<p><strong>KNN_SUBWAY_dist_mean:</strong> Average walking distance to nearest subway stations shows most tracts generally have reasonable transit access, and this is unsurprising as NYC is the only city in the US with public transport as its main commute / modality for citizens. Although the variation suggests transit deserts exist.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/correlation_matrix.png" class="img-fluid figure-img"></p>
<figcaption><em>Correlation Matrix</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/correlation_horizontal_bar.png" class="img-fluid figure-img"></p>
<figcaption><em>Correlation Horizontal Divergent Bar Plot</em></figcaption>
</figure>
</div>
<p><strong>Extreme Heat and Normal Weeks:</strong> Heat week and normal week call rates show strong positive correlation, indicating neighborhoods with high baseline complaint rates also show elevated rates during heat periods. Again, imperfect correlation suggests heat amplifies complaints differently, with some tracts having proportionally larger increases than baseline activity.</p>
<p><strong>Tree Canopy and NDVI Correlation:</strong> Tree canopy coverage and NDVI measure related environmental characteristics. But it also suggests that they both capture unique aspects, especially since NDVI reflects all vegetation including grass / shrubs while tree canopy specifically quantifies woody vegetation providing shade.</p>
<p><strong>Impervious Surface Relationships:</strong> Negative correlations show expected trade-off between built environment and green space. But there are some tracts with high vegetation despite substantial impervious coverage, potentially through street trees, small parks, or green infrastructure.</p>
<p><strong>Income and Education Correlation:</strong> Strong positive association between higher education and median income is expected.</p>
<p><strong>Income and Poverty Correlation:</strong> Extremely strong negative correlation creates redundancy as these variables measure opposite ends of same economic spectrum.</p>
<p><strong>Race and Poverty Correlation:</strong> Moderate positive correlation between percent non-white and poverty rate reflects persistent structural racism and residential segregation in NYC.</p>
<p><strong>Building Density and Height Correlation:</strong> Moderate positive correlation suggests taller buildings tend to cluster in denser areas.</p>
<p><strong>POI Density and Subway Access Correlation:</strong> Negative correlation indicates that commercial centers concentrate near transit. However, stats indicate deserts with commercial activity and transit-rich residential zones both exist.</p>
<p><strong>Green Space and Heat Calls Correlation:</strong> Weak negative correlations support the hypothesis on buffering effects, though relationships are weaker than anticipated. However, this may require nonlinear modeling or interaction terms to capture threshold effects.</p>
<p><strong>Income and Heat Calls Correlation:</strong> Near-zero or weakly positive correlation challenges simple vulnerability narrative, supporting one of the hypotheses of nuanced prediction that affluent areas may show increased reporting despite lower physiological vulnerability.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/vif_horizontal_bar.png" class="img-fluid figure-img"></p>
<figcaption><em>VIF Horizontal Bar Plot</em></figcaption>
</figure>
</div>
<p><strong>Critical VIF Violations (10 &lt; VIF)</strong></p>
<p>PCT_RENTERS, BD, and PCT_IMPERVIOUS are likely very correlated with one another as imperviousness and building density have overlapping measures of the physical city, whereas renters as opposed to owners will be concentrated in denser areas.</p>
<p>PCT_BACHELORS_PLUS and MEDIAN_INCOME are expectedly correlated with one another as higher educational attainment often meets that higher earning gradient.</p>
<p>NDVI’s high VIF indicates a correlation with its inverse of impervious surface as well as correlation with PCT_TREE_CANOPY. It may have a higher VIF due to its broader measurements that capture more city characteristics than tree canopy.</p>
<p>PCT_NON_WHITE is likely associated with POVERTY_RATE, but the former may capture more broad sociodemographics, hence the higher VIF.</p>
<p><strong>Moderate Multicollinearity Concerns (5 &lt; VIF &lt; 10)</strong></p>
<p>POVERTY_RATE and KNN_SUBWAY_dist_mean are moderately multicollinear, the former with MEDIAN_INCOME and PCT_NON_WHITE and the latter with the urban form variables. However, these metrics do not have as drastic of VIF values as their related counterparts.</p>
<p><strong>Acceptable VIF Range (VIF &lt; 5)</strong></p>
<p>Low VIF for WCR, PCT_LIMITED_ENGLISH, POI_DENSITY, AH, and PCT_TREE_CANOPY indicate that these are the most distinct and independent variables from 311 QoL reports in heat.</p>
<p>With this, it seems the variables cluster strongly and reveal that socioeconomic and environmental inequality is not composed of independent factors, but rather tightly bundled mechanisms that drive 311 reporting behavior. This means that OLS, while providing an interpretable baseline, is not ideal for capturing all these variables, reinforcing the need for models robust against multicollinearity like Random Forest.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/target_variable_map.png" class="img-fluid figure-img"></p>
<figcaption><em>Target Variable Map</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/environment_map.png" class="img-fluid figure-img"></p>
<figcaption><em>Environmental Predictors Map</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/socioeconomic_map.png" class="img-fluid figure-img"></p>
<figcaption><em>Socioeconomic Predictors Map</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/EDA/urban_map.png" class="img-fluid figure-img"></p>
<figcaption><em>Urban Form Predictors Map</em></figcaption>
</figure>
</div>
<p>The outliers significantly wash out the other tracts in NYC, many 311 super users are in the Queens Borough in the Long Island City area right around LaGuardia Community College. This general area looks like it has a higher non-white and higher poverty rate.</p>
<p>Most notably, the percent change map looks like it lacks spatial autocorrelation, but visually the impact must be influenced by some scattered tracts with low baseline activity that makes it look fragmented. This must indicate some kind of stress that’s unique to the tracts and their mechanism shifts.</p>
<p>Despite the visual scattered perception, it does look like that the changes are more skewed toward peripheral edges of the boroughs.</p>
<p>Also, MEDIAN_INCOME and PCT_BACHELORS_PLUS show an almost inverse spatial pattern when compared to PCT_NON_WHITE.</p>
</section>
<section id="ols-model-results" class="level2">
<h2 class="anchored" data-anchor-id="ols-model-results">3.2. OLS Model Results</h2>
<section id="normal-heat-model" class="level3">
<h3 class="anchored" data-anchor-id="normal-heat-model">3.2.1 Normal Heat Model</h3>
<p>In the OLS model for normal heat week QoF 311 report density, the overall F-statistic is strongly significant, indicating that the set of urban features jointly contributes meaningfully to explaining variation in reporting behavior. The R-squared of 0.084 shows that these predictors account for roughly 8% of the spatial variation, which presents a modest and low level of explanatory power that is typical for urban planning research on 311-based analyses. Such 311 outcomes reflect that service-request behavior is shaped by complex human responses, institutional factors, and informal social dynamics that are only partially captured by observable indicators. The relatively low R-squared also suggests the non-linear relationships might exist between urban features and 311 reporting behavior, indicating that machine-learning models may be more suitable for uncovering these non-linearities.</p>
<p>Regarding individual predictors, under the 0.05 significance threshold and within the linear OLS framework, seven features show statistically significant associations with QoF 311 report density during normal heat weeks: PCT_TREE_CANOPY, PCT_IMPERVIOUS, NDVI, POVERTY_RATE, PCT_NON_WHITE, BD, and AH. All remaining variables exhibit no significant linear effect.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/OLS_extreme_heat_table.png" class="img-fluid figure-img"></p>
<figcaption><em>Extreme Heat Week OLS Results</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/OLS_regular_heat_table.png" class="img-fluid figure-img"></p>
<figcaption><em>Normal Heat Week OLS Results</em></figcaption>
</figure>
</div>
</section>
<section id="extreme-heat-model" class="level3">
<h3 class="anchored" data-anchor-id="extreme-heat-model">3.2.2 Extreme Heat Model</h3>
<p>In the OLS model for extreme heat–week QoF 311 report density, the overall F-statistic is highly significant, indicating that the set of urban features jointly provides meaningful explanatory power. The model’s R-squared of 0.088 shows that these variables account for roughly 8–9% of the spatial variation, which also shows a limited explanatory power. The relatively low R-squared also suggests the non-linear relationships might exist between urban features and 311 reporting behavior in extreme heat weeks.</p>
<p>Regarding individual features, under the 0.05 significance threshold and the linearity assumption inherent to OLS, six features exhibit statistically significant associations with QoF 311 report density during extreme heat weeks: PCT_IMPERVIOUS, NDVI, POVERTY_RATE, PCT_NON_WHITE, BD, and AH. All other variables show no significant linear relationship after controlling for the rest of the model, implying that their effects may be weak, or more accurately represented through non-linear structures.</p>
</section>
<section id="ols-comparison" class="level3">
<h3 class="anchored" data-anchor-id="ols-comparison">3.2.3 OLS Comparison</h3>
<p>Across both the extreme-heat-week and normal-heat-week OLS models, only about half of the urban features exhibit statistically significant linear associations with QoF 311 report density, and both models yield low explanatory power (R² &lt; 0.10). This consistency indicates that the linear models capture only a small portion of the urban environmental, socioeconomic, and built indicators driving 311 reporting. Taken together, these results reinforce the limitations of linear OLS for this problem. They highlight the need for machine-learning approaches that can better capture non-linear effects, enabling a more precise comparison of how urban features influence 311 reporting differently under extreme heat versus normal heat conditions.</p>
</section>
</section>
<section id="ml-and-shap-results" class="level2">
<h2 class="anchored" data-anchor-id="ml-and-shap-results">3.3. ML and SHAP Results</h2>
<section id="ml-model-result" class="level3">
<h3 class="anchored" data-anchor-id="ml-model-result">3.3.1 ML Model Result</h3>
<p>Across both models, Random Forest substantially outperforms the OLS baseline, demonstrating the importance of non-linear and complex effects in explaining QoF 311 report density. For the regular heat week model, the test R2 reaches 0.274, over three times higher than the OLS R2 of approximately 0.08. Similarly, the extreme heat week model attains a test R^2of 0.246, again far exceeding the linear model but slightly lower than the regular heat scenario. This gap suggests that reporting behaviors during extreme heat is more variable and influenced by additional unobserved or volatile mechanisms. The clear improvements in model performance in both cases further confirm that machine-learning approaches capture substantial structure in the data that linear models fail to represent.</p>
<p>SHAP results reveal a consistent set of dominant predictors across both heat conditions. In each model, AH, PCT_NON_WHITE, and NDVI emerge as the three strongest contributors, reinforcing the central role of high-density residential morphology, socio-demographic composition, and environmental greenness in shaping QoF 311 reporting patterns. Several other predictors, such as subway accessibility, median income, WCR, poverty rate, and PCT_RENTERS, also exhibit meaningful non-linear contributions that were not visible in OLS, underscoring the value of ML models for uncovering complex behavioral responses.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/SHAP2/SHAP_beeswarm_facet.png" class="img-fluid figure-img"></p>
<figcaption><em>SHAP Importance Beeswarm Plots</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/SHAP2/SHAP_bar_facet.png" class="img-fluid figure-img"></p>
<figcaption><em>SHAP Importance Bar Charts</em></figcaption>
</figure>
</div>
</section>
<section id="extreme-heat-vs-normal-heat" class="level3">
<h3 class="anchored" data-anchor-id="extreme-heat-vs-normal-heat">3.3.2 Extreme Heat vs Normal Heat</h3>
<p>Comparing the two heat conditions reveals both stability and notable shifts in feature influence. The hierarchy of the top four features, AH, PCT_NON_WHITE, NDVI, and KNN_SUBWAY_dist_mean remains consistent across models, suggesting that built form intensity, demographic composition, and urban greenery systematically shape reporting behaviors in both normal and extreme heat contexts. These stable high-importance variables reflect structural neighborhood characteristics whose effects persist regardless of temperature severity.</p>
<p>However, several features display meaningful changes in importance under extreme heat. WCR increases in influence in the extreme heat model, indicating that proximity to water bodies may play a more substantial role when heat stress intensifies, possibly reflecting shifts in human activity patterns or uneven access to cooling amenities. In contrast, some variables such as PCT_IMPERVIOUS, BD, and PCT_TREE_CANOPY show moderate decreases in relative importance, suggesting that some physical morphology may matter slightly less once temperatures exceed critical thresholds. Overall, these patterns indicate that while the core drivers of 311 reporting remain stable, the marginal influence of secondary features is sensitive to heat severity.</p>
</section>
<section id="non-linear-relationship-for-features" class="level3">
<h3 class="anchored" data-anchor-id="non-linear-relationship-for-features">3.3.3 Non-Linear Relationship for Features</h3>
<p>Across the SHAP scatter plots for both the extreme heat and normal heat models, clear non-linear relationships emerge for most features. Only NDVI and POVERTY_RATE exhibit relatively consistent linear patterns, while all other features display visibly complex, non-monotonic trends. A prominent example is AH, the most influential features in both models: although AH appears significant in OLS, its relationship revealed by SHAP approach is distinctly U-shaped in both heat conditions. This means that both low and high AH values are associated with higher predicted 311 report density, whereas medium AH values correspond to the lowest predicted levels.</p>
<p>Similarly, PCT_NON_WHITE and PCT_RENTERS show a characteristic inverted-U pattern in both models, where extreme low or high values of these features correspond to lower 311 reporting density, and intermediate values correspond to higher levels. An interesting shift between the two heat conditions appears in the behavior of BD: in the regular heat model, BD follows an inverted-U shape, but in the extreme heat model, this pattern transitions into an approximately linear negative relationship.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/SHAP2/shap_scatter_plots_heat/SHAP_facet_5x3_grid_heat.png" class="img-fluid figure-img"></p>
<figcaption><em>Extreme Heat Week Scatter Plots</em></figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="notebooks/images/SHAP2/shap_scatter_plots_regular/SHAP_facet_5x3_grid_regular.png" class="img-fluid figure-img"></p>
<figcaption><em>Normal Heat Week Scatter Plots</em></figcaption>
</figure>
</div>
</section>
</section>
</section>
<section id="discussion" class="level1">
<h1>4. DISCUSSION</h1>
<section id="result-interpretation-discussion" class="level2">
<h2 class="anchored" data-anchor-id="result-interpretation-discussion">4.1 Result Interpretation &amp; Discussion</h2>
<p>Overall, the ML models fit the data substantially better than the OLS models and capture more complex and non-linear relationships between urban features and QoF 311 report density. The Random Forest for regular heat weeks attains a slightly higher R2 than the extreme-heat model, suggesting that QoF 311 reporting during extreme heat might be more complex and harder to explain with observed features. Across both heat conditions, four features consistently emerge as the top contributors: AH, PCT_NON_WHITE, NDVI, and KNN_SUBWAY_dist_mean, highlighting the persistent importance of building height, demographic composition, urban greenery, and transit-related spatial configuration. At the same time, WCR becomes noticeably more important under extreme heat, indicating that proximity to water gains salience for QoF outcomes when temperatures are very high. By contrast, the relative contributions of PCT_IMPERVIOUS, BD, and PCT_TREE_CANOPY decline slightly in the extreme-heat model, which may suggest that beyond certain temperature thresholds the marginal QoF benefits or harms associated with these features become constrained or saturated.</p>
<p>The SHAP scatter plots further show that non-linear effects are the rule rather than the exception. Only a small number of predictors display relatively clear linear relationships, most notably NDVI and POVERTY_RATE, both of which are approximately linear and negatively associated with predicted 311 density. For NDVI, this pattern indicates that higher levels of greenery are consistently linked to fewer QoF-related report density, in line with the cooling and comfort-enhancing role of vegetation. The negative slope for POVERTY_RATE, however, is better interpreted as an artefact of reporting bias: residents in poorer neighborhoods may face more barriers to using the 311 system, so their problems are less likely to be recorded. Other variables, such as PCT_IMPERVIOUS and MEDIAN_INCOME, are broadly monotonic positive but clearly non-linear—higher imperviousness is associated with greater predicted 311 density, and higher income with more reports, the latter again likely reflecting under-reporting in very low-income areas. In contrast, KNN_SUBWAY_dist_mean, PCT_TREE_CANOPY, and POI_500M_DENSITY are approximately monotonic negative, suggesting that better transit accessibility, more tree canopy, and higher local amenity density are each associated with lower predicted 311 density and thus better perceived QoF.</p>
<p>Several key predictors exhibit explicitly non-monotonic shapes. AH shows a robust U-shaped relationship in both models: neighborhoods with either very low or very high average building heights have elevated predicted 311 density, whereas areas with medium AH show the lowest levels. A plausible interpretation is that low-rise areas are more directly exposed to heat, while very tall building environments may suffer from strong street-canyon effects and poor ventilation; intermediate heights may balance shading and airflow, leading to fewer QoF-related complaints. PCT_NON_WHITE and PCT_RENTERS both follow an inverted-U pattern: tracts with very low or very high values have relatively low predicted 311 density, while mixed or intermediate levels are associated with higher reporting. This may reflect both underlying social dynamics in mixed areas and systematic biases in who uses the 311 system. Finally, BD displays an inverted-U shape under regular heat, but becomes roughly monotonic negative under extreme heat. One simple reading is that, in moderate heat, medium-density environments combine sufficient population and activity to generate high reporting rates, whereas very low- and very high-density areas generate fewer calls; under extreme heat, however, higher built density may increasingly coincide with stronger adaptation measures or more indoor retreat, producing a more uniformly negative association with QoF 311 reporting. Together, these patterns underline that the relationships between urban form, social composition, and environment and QoF are highly non-linear and context dependent.</p>
</section>
<section id="limitation" class="level2">
<h2 class="anchored" data-anchor-id="limitation">4.2 Limitation</h2>
<p>This study has several limitations. First, the analysis focuses on a single summer season in 2025, which may restrict the temporal representativeness of the findings; extending the study period to multiple years (e.g., 2021–2024) would allow for increasing the reliability and representative of our findings. Second, although 311-based outcomes are inherently difficult to fully explain, the Random Forest R2 of around 0.25 indicates that there is still substantial unexplained variance. Incorporating additional environmental, socio-economic, and spatial variables could further improve model performance and yield a more complete picture of the drivers of QoF-related 311 report density.</p>
</section>
</section>
<section id="references" class="level1">
<h1>5. REFERENCES</h1>
<p>Harlan, S. L., Brazel, A. J., Prashad, L., Stefanov, W. L., &amp; Larsen, L. (2006). Neighborhood microclimates and vulnerability to heat stress. <em>Social Science &amp; Medicine</em>, 63(11), 2847–2863. <a href="https://doi.org/10.1016/j.socscimed.2006.07.030" class="uri">https://doi.org/10.1016/j.socscimed.2006.07.030</a></p>
<p>Hsu, A., Sheriff, G., Chakraborty, T., &amp; Manya, D. (2021). Disproportionate exposure to urban heat island intensity across major US cities. <em>Nature Communications</em>, 12(1). <a href="https://doi.org/10.1038/s41467-021-22799-5" class="uri">https://doi.org/10.1038/s41467-021-22799-5</a></p>
<p>Kontokosta, C. E., &amp; Tull, C. (2017). A data-driven predictive model of city-scale energy use in buildings. <em>Applied Energy</em>, 197, 303–317. <a href="https://doi.org/10.1016/j.apenergy.2017.04.005" class="uri">https://doi.org/10.1016/j.apenergy.2017.04.005</a></p>
<p>Lundberg, S., &amp; Lee, S.-I. (2017). A unified approach to interpreting model predictions. <em>NIPS’17: Proceedings of the 31st International Conference on Neural Information Processing Systems</em>, 9781510860964. <a href="https://doi.org/10.5555/3295222.3295230" class="uri">https://doi.org/10.5555/3295222.3295230</a></p>
<p>Uejio, C. K., Wilhelmi, O. V., Golden, J. S., Mills, D. M., Gulino, S. P., &amp; Samenow, J. P. (2010). Intra-urban societal vulnerability to extreme heat: The role of heat exposure and the built environment, socioeconomics, and neighborhood stability. <em>Health &amp; Place</em>, 17(2), 498–507. <a href="https://doi.org/10.1016/j.healthplace.2010.12.005" class="uri">https://doi.org/10.1016/j.healthplace.2010.12.005</a></p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>