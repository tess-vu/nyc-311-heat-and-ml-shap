<div class="content-middle">
    <h1>CODE: NLCD Raster Calculations</h1>
    <h2>Hot City, Heated Calls:<br>Understanding Extreme Heat and Quality of Life<br>Using New York City's 311 and SHAP</h2>
    
    <p class="notebook-description">Zonal statistics for tree canopy and impervious surface from NLCD data.</p>
    
    <div class="notebook-controls">
        <button onclick="toggleAllCode(true)" class="code-toggle-btn">Show All Code</button>
        <button onclick="toggleAllCode(false)" class="code-toggle-btn">Hide All Code</button>
    </div>
    
    <div class="notebook-nav-buttons">
        <a href="#" data-page="04e_code_additional_features" class="notebook-prev">← 4. Additional Features</a>
        <a href="#" data-page="04g_code_data_merging" class="notebook-next">6. Data Merging →</a>
    </div>
    
    <div class="report-content notebook-content">
<div class="cell-markdown"><h2>NLCD RASTERS</h2>
Extract tree canopy and impervious percentages.</div>

<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 1</summary>
        <pre class="cell-code"><code># Modules.
import os
from pathlib import Path
import numpy as np
import rasterio
from rasterio.mask import mask
from rasterio.warp import reproject, Resampling
import geopandas as gpd
from tqdm import tqdm
from rasterstats import zonal_stats</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 2</summary>
        <pre class="cell-code"><code># Paths.
nlcd_tree_path = Path(&quot;data/raster/nlcd_raster/nlcd_tree_canopy_2023.tiff&quot;)
nlcd_impervious_path = Path(&quot;data/raster/nyc_impervious_2024.tif&quot;)

tracts_path = Path(&quot;data/nyc_tracts_2020/nyc_tracts_2020.shp&quot;)

output_dir = Path(&quot;data/raster/processed&quot;)
output_dir.mkdir(parents = True, exist_ok = True)

tracts = gpd.read_file(tracts_path).to_crs(32118)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 3</summary>
        <pre class="cell-code"><code># Zonal statistics for NCLD.
def zonal_mean(rpath, gdf_or_geom):
    &quot;&quot;&quot;Apply CRS zonal mean for tracts or city boundary.&quot;&quot;&quot;
    with rasterio.open(rpath) as src:
        r_crs = src.crs

    if isinstance(gdf_or_geom, (gpd.GeoSeries, gpd.GeoDataFrame)):
        gdf = gdf_or_geom.to_crs(r_crs)
    else:
        gdf = gpd.GeoSeries([gdf_or_geom], crs = 32118).to_crs(r_crs)

    return zonal_stats(gdf, rpath, stats = [&quot;mean&quot;], nodata = np.nan)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 4</summary>
        <pre class="cell-code"><code># Print checks for the calculations.
print(&quot;Tree canopy zonal stats:&quot;)
tree = zonal_mean(nlcd_tree_path, tracts)
print(tree)
print(&quot;Impervious zonal stats:&quot;)
impervious = zonal_mean(nlcd_impervious_path, tracts)
print(impervious)

tracts[&quot;pct_tree_canopy&quot;] = [t[&quot;mean&quot;] for t in tree]
tracts[&quot;pct_impervious&quot;] = [i[&quot;mean&quot;] for i in impervious]</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-stream">Tree canopy zonal stats:
[{&#x27;mean&#x27;: 10.126984126984127}, {&#x27;mean&#x27;: 13.314285714285715}, {&#x27;mean&#x27;: 0.592}, {&#x27;mean&#x27;: 3.076305220883534}, {&#x27;mean&#x27;: 6.089887640449438}, {&#x27;mean&#x27;: 2.736842105263158}, {&#x27;mean&#x27;: 1.7009803921568627}, {&#x27;mean&#x27;: 1.2598870056497176}, {&#x27;mean&#x27;: 6.25}, {&#x27;mean&#x27;: 2.8217821782178216}, {&#x27;mean&#x27;: 0.4077669902912621}, {&#x27;mean&#x27;: 1.0520833333333333}, {&#x27;mean&#x27;: 0.047619047619047616}, {&#x27;mean&#x27;: 1.2023809523809523}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 7.0647482014388485}, {&#x27;mean&#x27;: 0.07936507936507936}, {&#x27;mean&#x27;: 0.05154639175257732}, {&#x27;mean&#x27;: 1.3650793650793651}, {&#x27;mean&#x27;: 0.15025906735751296}, {&#x27;mean&#x27;: 6.22}, {&#x27;mean&#x27;: 0.6020408163265306}, {&#x27;mean&#x27;: 0.39896373056994816}, {&#x27;mean&#x27;: 0.6956521739130435}, {&#x27;mean&#x27;: 0.19270833333333334}, {&#x27;mean&#x27;: 1.517766497461929}, {&#x27;mean&#x27;: 4.198979591836735}, {&#x27;mean&#x27;: 0.387434554973822}, {&#x27;mean&#x27;: 0.10256410256410256}, {&#x27;mean&#x27;: 0.05235602094240838}, {&#x27;mean&#x27;: 0.8134715025906736}, {&#x27;mean&#x27;: 4.455958549222798}, {&#x27;mean&#x27;: 3.572972972972973}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 4.678391959798995}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 1.3679245283018868}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.16580310880829016}, {&#x27;mean&#x27;: 0.6375}, {&#x27;mean&#x27;: 0.15625}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.07142857142857142}, {&#x27;mean&#x27;: 0.32954545454545453}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 0.6306306306306306}, {&#x27;mean&#x27;: 2.5786802030456855}, {&#x27;mean&#x27;: 0.0}, {&#x27;mean&#x27;: 1.1614583333333333}, {&#x27;mean&#x27;: 0.10204081632653061}, {&#x27;mean&#x27;: 0.59}, {&#x27;mean&#x27;: 0.953125}, {&#x27;mean&#x27;: 0.05154639175257732}, {&#x27;mean&#x27;: 1.5339805825242718}, {&#x27;mean&#x27;: 1.606060606060606}, {&#x27;mean&#x27;: 0.7680412371134021}, {&#x27;mean&#x27;: 1.7868020304568528}, {&#x27;mean&#x27;: 0.05699481865284974}, {&#x27;mean&#x27;: 0.15294117647058825}, {&#x27;mean&#x27;: 5.6}, {&#x27;mean&#x27;: 0.7525773195876289}, {&#x27;mean&#x27;: 0.65}, {&#x27;mean&#x27;: 0.8571428571428571}, {&#x27;mean&#x27;: 0.4482758620689655}, {&#x27;mean&#x27;: 1.1649484536082475}, {&#x27;mean&#x27;: 1.6551724137931034}, {&#x27;mean&#x27;: 1.6}, {&#x27;mean&#x27;: 8.90983606557377}, {&#x27;mean&#x27;: 0.9375}, {&#x27;mean&#x27;: 0.6632653061224489}, {&#x27;mean&#x27;: 5.6875}, {&#x27;mean&#x27;: 0.3442622950819672}, {&#x27;mean&#x27;: 7.12280701754386}, {&#x27;mean&#x27;: 11.072916666666666}, {&#x27;mean&#x27;: 0.26732673267326734}, {&#x27;mean&#x27;: 1.5602836879432624}, {&#x27;mean&#x27;: 0.8392857142857143}, {&#x27;mean&#x27;: 1.6906474820143884}, {&#x27;mean&#x27;: 1.36}, {&#x27;mean&#x27;: 9.269035532994923}, {&#x27;mean&#x27;: 10.030837004405287}, {&#x27;mean&#x27;: 2.9076923076923076}, {&#x27;mean&#x27;: 0.465}, {&#x27;mean&#x27;: 14.548936170212766}, {&#x27;mean&#x27;: 1.8172588832487309}, {&#x27;mean&#x27;: 1.803030303030303}, {&#x27;mean&#x27;: 4.918918918918919}, {&#x27;mean&#x27;: 1.9824561403508771}, {&#x27;mean&#x27;: 13.605042016806722}, {&#x27;mean&#x27;: 3.8969072164948453}, {&#x27;mean&#x27;: 6.851694915254237}, {&#x27;mean&#x27;: 1.367741935483871}, {&#x27;mean&#x27;: 6.197969543147208}, {&#x27;mean&#x27;: 12.355555555555556}, {&#x27;mean&#x27;: 20.541666666666668}, {&#x27;mean&#x27;: 1.6717948717948719}, {&#x27;mean&#x27;: 1.8934010152284264}, {&#x27;mean&#x27;: 1.537037037037037}, {&#x27;mean&#x27;: 22.463414634146343}, {&#x27;mean&#x27;: 1.8363636363636364}, {&#x27;mean&#x27;: 0.46153846153846156}, {&#x27;mean&#x27;: 0.8493975903614458}, {&#x27;mean&#x27;: 1.4311377245508983}, {&#x27;mean&#x27;: 1.1818181818181819}, {&#x27;mean&#x27;: 22.27220630372493}, {&#x27;mean&#x27;: 1.349753694581280
... [output truncated]</pre>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 5</summary>
        <pre class="cell-code"><code>tracts.columns = tracts.columns.str.upper()
tracts = tracts.rename(columns = {&quot;GEOMETRY&quot;: &quot;geometry&quot;})

tracts.head()</code></pre>
    </details>
    <div class="cell-outputs">
<div class="output-html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CTLABEL</th>
      <th>BOROCODE</th>
      <th>BORONAME</th>
      <th>CT2020</th>
      <th>BOROCT2020</th>
      <th>CDELIGIBIL</th>
      <th>NTANAME</th>
      <th>NTA2020</th>
      <th>CDTA2020</th>
      <th>CDTANAME</th>
      <th>GEOID</th>
      <th>SHAPE_LENG</th>
      <th>SHAPE_AREA</th>
      <th>geometry</th>
      <th>PCT_TREE_CANOPY</th>
      <th>PCT_IMPERVIOUS</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>000100</td>
      <td>1000100</td>
      <td>I</td>
      <td>The Battery-Governors Island-Ellis Island-Libe...</td>
      <td>MN0191</td>
      <td>MN01</td>
      <td>MN01 Financial District-Tribeca (CD 1 Equivalent)</td>
      <td>36061000100</td>
      <td>10833.043929</td>
      <td>1.843005e+06</td>
      <td>MULTIPOLYGON (((296291.11 58135.714, 296322.49...</td>
      <td>10.126984</td>
      <td>46.973545</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14.01</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>001401</td>
      <td>1001401</td>
      <td>I</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061001401</td>
      <td>5075.332000</td>
      <td>1.006117e+06</td>
      <td>POLYGON ((300982.972 61050.77, 301053.207 6102...</td>
      <td>13.314286</td>
      <td>69.590476</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14.02</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>001402</td>
      <td>1001402</td>
      <td>E</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061001402</td>
      <td>4459.156019</td>
      <td>1.226206e+06</td>
      <td>POLYGON ((301261.149 61343.714, 301332.269 613...</td>
      <td>0.592000</td>
      <td>83.656000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>001800</td>
      <td>1001800</td>
      <td>I</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061001800</td>
      <td>6391.921174</td>
      <td>2.399277e+06</td>
      <td>POLYGON ((300857.167 61503.238, 300868.535 614...</td>
      <td>3.076305</td>
      <td>81.887550</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22.01</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>002201</td>
      <td>1002201</td>
      <td>E</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061002201</td>
      <td>5779.062607</td>
      <td>1.740174e+06</td>
      <td>POLYGON ((301795.202 61438.262, 301792.173 614...</td>
      <td>6.089888</td>
      <td>78.735955</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 6</summary>
        <pre class="cell-code"><code>tracts.columns</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-text">Index([&#x27;CTLABEL&#x27;, &#x27;BOROCODE&#x27;, &#x27;BORONAME&#x27;, &#x27;CT2020&#x27;, &#x27;BOROCT2020&#x27;, &#x27;CDELIGIBIL&#x27;,
       &#x27;NTANAME&#x27;, &#x27;NTA2020&#x27;, &#x27;CDTA2020&#x27;, &#x27;CDTANAME&#x27;, &#x27;GEOID&#x27;, &#x27;SHAPE_LENG&#x27;,
       &#x27;SHAPE_AREA&#x27;, &#x27;geometry&#x27;, &#x27;PCT_TREE_CANOPY&#x27;, &#x27;PCT_IMPERVIOUS&#x27;],
      dtype=&#x27;object&#x27;)</pre>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 7</summary>
        <pre class="cell-code"><code>tracts = tracts.drop(columns = [&#x27;CTLABEL&#x27;, &#x27;BOROCODE&#x27;, &#x27;BORONAME&#x27;, &#x27;CT2020&#x27;,
                       &#x27;BOROCT2020&#x27;, &#x27;CDELIGIBIL&#x27;, &#x27;NTANAME&#x27;, &#x27;NTA2020&#x27;,
                       &#x27;CDTA2020&#x27;, &#x27;CDTANAME&#x27;, &#x27;SHAPE_LENG&#x27;, &#x27;SHAPE_AREA&#x27;])</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 8</summary>
        <pre class="cell-code"><code>tracts.columns</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-text">Index([&#x27;GEOID&#x27;, &#x27;geometry&#x27;, &#x27;PCT_TREE_CANOPY&#x27;, &#x27;PCT_IMPERVIOUS&#x27;], dtype=&#x27;object&#x27;)</pre>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 9</summary>
        <pre class="cell-code"><code># Save as geojson.
geojson_out = output_dir.parent / &quot;nlcd_calc_tracts.geojson&quot;
geojson_out.parent.mkdir(parents = True, exist_ok = True)
tracts.to_file(geojson_out)
print(&quot;Saved:&quot;, geojson_out)

# Save as csv.
csv_out = output_dir.parent / &quot;nlcd_calc_tracts.csv&quot;
tracts.drop(columns = [&quot;geometry&quot;]).to_csv(csv_out, index = False)
print(&quot;Saved CSV:&quot;, csv_out)</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-stream">Saved: data\raster\nlcd_calc_tracts.geojson
Saved CSV: data\raster\nlcd_calc_tracts.csv
</pre>
</div>
</div>

    </div>
    
    <div class="notebook-nav-buttons notebook-nav-bottom">
        <a href="#" data-page="04e_code_additional_features" class="notebook-prev">← 4. Additional Features</a>
        <a href="#" data-page="04g_code_data_merging" class="notebook-next">6. Data Merging →</a>
    </div>
</div>

<div class="content-right">
    <div class="panel-right-content">
        <h2>Notebooks</h2>
        <ul class="notebook-nav-list">
            <li class=""><a href="#" data-page="04a_code_weather_stations">1a. Weather Stations</a></li>
<li class=""><a href="#" data-page="04b_code_heat_classification">1b. Heat Classification</a></li>
<li class=""><a href="#" data-page="04c_code_311_processing">2. 311 Processing</a></li>
<li class=""><a href="#" data-page="04d_code_census_acs">3. Census ACS</a></li>
<li class=""><a href="#" data-page="04e_code_additional_features">4. Additional Features</a></li>
<li class="notebook-nav-current"><a href="#" data-page="04f_code_nlcd_rasters">5. NLCD Rasters</a></li>
<li class=""><a href="#" data-page="04g_code_data_merging">6. Data Merging</a></li>
<li class=""><a href="#" data-page="04h_code_eda">7. EDA</a></li>
<li class=""><a href="#" data-page="04i_code_ols_ml_shap">8. OLS & ML + SHAP</a></li>
        </ul>
        
        <h2>This Notebook</h2>
        <p><b>Source:</b> 05_nlcd_calculations.ipynb</p>
        <p><b>Code Cells:</b> 9</p>
        <p><b>Figures:</b> 0</p>
    </div>
    <div class="panel-right-footer">
        <h3>Data Pipeline</h3>
        <h5>Weather → 311 → Census → Features → Merge → EDA → Modeling</h5>
    </div>
</div>