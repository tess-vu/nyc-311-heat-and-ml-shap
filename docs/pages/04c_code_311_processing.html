<div class="content-middle">
    <h1>CODE: NYC 311 Data Processing</h1>
    <h2>Hot City, Heated Calls:<br>Understanding Extreme Heat and Quality of Life<br>Using New York City's 311 and SHAP</h2>
    
    <p class="notebook-description">Processing 311 service requests and aggregating QoL complaints by census tract.</p>
    
    <div class="notebook-controls">
        <button onclick="toggleAllCode(true)" class="code-toggle-btn">Show All Code</button>
        <button onclick="toggleAllCode(false)" class="code-toggle-btn">Hide All Code</button>
    </div>
    
    <div class="notebook-nav-buttons">
        <a href="#" data-page="04b_code_heat_classification" class="notebook-prev">← 1b. Heat Classification</a>
        <a href="#" data-page="04d_code_census_acs" class="notebook-next">3. Census ACS →</a>
    </div>
    
    <div class="report-content notebook-content">
<div class="cell-markdown"><h2>311 QUALITY OF LIFE BY TRACTS</h2>
<p>Extract quality-of-life-related 311 reports in NYC.</p></div>

<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 1</summary>
        <pre class="cell-code"><code># Modules.
import pandas as pd
import geopandas as gpd
import numpy as np
from shapely.geometry import Point
import requests, time
from pathlib import Path</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 2</summary>
        <pre class="cell-code"><code># Paths.
nyc_311_dir = Path(&quot;data/nyc_311&quot;)
nyc_311 = nyc_311_dir / &quot;311_raw&quot;
nyc_311.mkdir(parents = True, exist_ok = True)

# NYC 2020 census tracts shapefile.
tracts_path = Path(&quot;data/nyc_tracts_2020/nyc_tracts_2020.shp&quot;)

# Output.
raw_path = nyc_311 / &quot;nyc_311_summer_2025.csv&quot;
panel_path = nyc_311_dir / &quot;nyc_311_tract_day_2025.csv&quot;
point_path_geojson = nyc_311_dir / &quot;nyc_311_points_2025.geojson&quot;</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 3</summary>
        <pre class="cell-code"><code># Noise and Social Activity (heat-sensitive)
QOL_NOISE = [
    &quot;LOUD MUSIC/PARTY&quot;, &quot;BANGING/POUNDING&quot;, &quot;LOUD TALKING&quot;,
    &quot;CAR/TRUCK MUSIC&quot;, &quot;CAR/TRUCK HORN&quot;, &quot;DOG NOISE&quot;,
    &quot;NOISE: BOAT(ENGINE,MUSIC,ETC) (NR10)&quot;,
    &quot;NOISE: ALARMS (NR3)&quot;,
    &quot;NOISE: AIR CONDITION/VENTILATION EQUIPMENT (NV1)&quot;,
    &quot;NOISE: CONSTRUCTION BEFORE/AFTER HOURS (NM1)&quot;,
    &quot;NOISE: JACK HAMMERING (NC2)&quot;,
    &quot;NOISE, BARKING DOG (NR5)&quot;,
    &quot;NOISE: MANUFACTURING NOISE (NK1)&quot;,
    &quot;NOISE: OTHER NOISE SOURCES (USE COMMENTS) (NZZ)&quot;
]

# Outdoor Activity / Public Space Use
QOL_OUTDOOR = [
    &quot;BLOCKED HYDRANT&quot;, &quot;BLOCKED SIDEWALK&quot;, &quot;BLOCKED BIKE LANE&quot;,
    &quot;ILLEGAL PARKING&quot;, &quot;DOUBLE PARKED BLOCKING TRAFFIC&quot;,
    &quot;BLOCKED CROSSWALK&quot;, &quot;DERELICT VEHICLES&quot;, &quot;CONGESTION/GRIDLOCK&quot;,
    &quot;GRAFFITI&quot;, &quot;CHRONIC DUMPING&quot;,
    &quot;COMMERCIAL OVERNIGHT PARKING&quot;
]

# Sanitation, Trash, Pests
QOL_SANITATION = [
    &quot;GARBAGE OR LITTER&quot;, &quot;TRASH&quot;, &quot;OVERFLOWING&quot;,
    &quot;RAT SIGHTING&quot;, &quot;MOUSE SIGHTING&quot;, &quot;CONDITION ATTRACTING RODENTS&quot;,
    &quot;PESTS&quot;, &quot;UNSANITARY CONDITION&quot;, &quot;DEAD ANIMAL&quot;,
    &quot;WASTE DISPOSAL&quot;, &quot;DOG WASTE&quot;
]

# Water Infrastructure &amp; Hydrants
QOL_WATER = [
    &quot;WATER LEAK&quot;, &quot;WATER SUPPLY&quot;, &quot;HYDRANT LEAKING (WC1)&quot;,
    &quot;HYDRANT RUNNING FULL (WA4)&quot;, &quot;HYDRANT RUNNING (WC3)&quot;,
    &quot;HYDRANT DEFECTIVE (WC2)&quot;, &quot;SEWER&quot;, &quot;SEWER ODOR (SA2)&quot;,
    &quot;SEWER BACKUP (SA)&quot;, &quot;LEAK (USE COMMENTS) (WA2)&quot;
]

# Infrastructure Heat Stress
QOL_INFRA_HEAT = [
    &quot;POWER OUTAGE&quot;, &quot;ELECTRICAL/GAS RANGE&quot;, &quot;VENTILATION SYSTEM&quot;,
    &quot;TRAFFIC SIGNAL LIGHT&quot;, &quot;STREET LIGHT OUT&quot;, 
    &quot;STREET LIGHT LAMP MISSING&quot;, &quot;STREET LIGHT CYCLING&quot;
]</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 4</summary>
        <pre class="cell-code"><code># Build lookup dictionary for mapping.
def build_qol_lookup():
    mapping = {}
    for c in QOL_NOISE: mapping[c] = &quot;QOL_NOISE&quot;
    for c in QOL_OUTDOOR: mapping[c] = &quot;QOL_OUTDOOR&quot;
    for c in QOL_SANITATION: mapping[c] = &quot;QOL_SANITATION&quot;
    for c in QOL_WATER: mapping[c] = &quot;QOL_WATER_INFRA&quot;
    for c in QOL_INFRA_HEAT: mapping[c] = &quot;QOL_INFRA_HEAT&quot;
    return mapping

QOL_LOOKUP = build_qol_lookup()</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 5</summary>
        <pre class="cell-code"><code># Download helper.
def download_311_jfk_2025(token = None):
    base = &quot;https://data.cityofnewyork.us/resource/erm2-nwe9.json&quot;
    headers = {&quot;X-App-Token&quot;: token} if token else {}
    limit = 50000

    start = &quot;2025-06-01T00:00:00&quot;
    end = &quot;2025-08-22T23:59:59&quot;

    where_clause = (
        f&quot;created_date between &#x27;{start}&#x27; and &#x27;{end}&#x27; &quot;
        &quot;AND latitude IS NOT NULL AND longitude IS NOT NULL&quot;
    )

    cols = [
        &quot;unique_key&quot;, &quot;created_date&quot;, &quot;complaint_type&quot;,
        &quot;descriptor&quot;, &quot;latitude&quot;, &quot;longitude&quot;, &quot;borough&quot;
    ]

    offset = 0
    frames = []

    while True:
        params = {
            &quot;$select&quot;: &quot;,&quot;.join(cols),
            &quot;$where&quot;: where_clause,
            &quot;$limit&quot;: limit,
            &quot;$offset&quot;: offset,
            &quot;$order&quot;: &quot;created_date&quot;
        }
        r = requests.get(base, params = params, headers = headers)
        data = r.json()
        if len(data) == 0:
            break

        frames.append(pd.DataFrame(data))
        print(&quot;Fetched:&quot;, len(data), &quot;offset:&quot;, offset)
        offset += limit
        time.sleep(0.3)

    df = pd.concat(frames, ignore_index = True)
    df.to_csv(raw_path, index = False)

    print(&quot;Saved:&quot;, raw_path)
    return df</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 6</summary>
        <pre class="cell-code"><code># Download.
calls_311 = download_311_jfk_2025(token = None)
calls_311[&quot;created_date&quot;] = pd.to_datetime(calls_311[&quot;created_date&quot;], errors = &quot;coerce&quot;)
calls_311[&quot;latitude&quot;] = pd.to_numeric(calls_311[&quot;latitude&quot;])
calls_311[&quot;longitude&quot;] = pd.to_numeric(calls_311[&quot;longitude&quot;])</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-stream">Fetched: 50000 offset: 0
Fetched: 50000 offset: 50000
Fetched: 50000 offset: 100000
Fetched: 50000 offset: 150000
Fetched: 50000 offset: 200000
Fetched: 50000 offset: 250000
Fetched: 50000 offset: 300000
Fetched: 50000 offset: 350000
Fetched: 50000 offset: 400000
Fetched: 50000 offset: 450000
Fetched: 50000 offset: 500000
Fetched: 50000 offset: 550000
Fetched: 50000 offset: 600000
Fetched: 50000 offset: 650000
Fetched: 26191 offset: 700000
Saved: data\nyc_311\311_raw\nyc_311_summer_2025.csv
</pre>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 7</summary>
        <pre class="cell-code"><code># Spatial join to tracts.
gdf_tracts = gpd.read_file(tracts_path)

nyc_prefixes = (&quot;36005&quot;, &quot;36047&quot;, &quot;36061&quot;, &quot;36081&quot;, &quot;36085&quot;)
gdf_tracts = gdf_tracts[gdf_tracts[&quot;geoid&quot;].str.startswith(nyc_prefixes)].copy()

gdf_311 = gpd.GeoDataFrame(
    calls_311,
    geometry=[Point(xy) for xy in zip(calls_311.longitude, calls_311.latitude)],
    crs = &quot;EPSG:4326&quot;
).to_crs(gdf_tracts.crs)

joined_gdf = gpd.sjoin(
    gdf_311,
    gdf_tracts[[&quot;geoid&quot;,&quot;geometry&quot;]],
    how = &quot;left&quot;,
    predicate = &quot;within&quot;
)

joined_gdf = joined_gdf.dropna(subset = [&quot;geoid&quot;]).copy()
joined_gdf.rename(columns = {&quot;geoid&quot;:&quot;GEOID&quot;}, inplace = True)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 8</summary>
        <pre class="cell-code"><code># Encode to QoL superclasses.
joined_gdf[&quot;ct_norm&quot;] = joined_gdf[&quot;complaint_type&quot;].str.upper().str.strip()
joined_gdf[&quot;qol_category&quot;] = joined_gdf[&quot;ct_norm&quot;].map(QOL_LOOKUP)

# Heat-relevant QoL calls.
joined_gdf[&quot;is_heat_qol&quot;] = joined_gdf[&quot;qol_category&quot;].notna()

# Build tract by day.
joined_gdf[&quot;date&quot;] = joined_gdf[&quot;created_date&quot;].dt.date

panel = (
    joined_gdf.groupby([&quot;GEOID&quot;,&quot;date&quot;], as_index = False)
    .agg(
        total_calls = (&quot;unique_key&quot;, &quot;count&quot;),
        qol_calls = (&quot;is_heat_qol&quot;, &quot;sum&quot;),
        #mean_latitude = (&quot;latitude&quot;, &quot;mean&quot;),
        #mean_longitude = (&quot;longitude&quot;, &quot;mean&quot;)
    )
)

panel[&quot;heat_qol_rate_1k&quot;] = (panel[&quot;qol_calls&quot;].astype(float))

panel[&quot;qol_pct&quot;] = np.where(
    panel[&quot;total_calls&quot;] &gt; 0,
    panel[&quot;qol_calls&quot;]/panel[&quot;total_calls&quot;],
    np.nan
)

panel.columns = panel.columns.str.upper()</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 9</summary>
        <pre class="cell-code"><code>panel.to_csv(panel_path, index = False)
print(&quot;Saved panel:&quot;, panel_path)

panel</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-stream">Saved panel: data/nyc_311/panel/nyc_311_tract_day_2025.csv
</pre>
<div class="output-html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GEOID</th>
      <th>DATE</th>
      <th>TOTAL_CALLS</th>
      <th>QOL_CALLS</th>
      <th>HEAT_QOL_RATE_1K</th>
      <th>QOL_PCT</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>36005000100</td>
      <td>2025-06-30</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>36005000100</td>
      <td>2025-07-23</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36005000100</td>
      <td>2025-08-04</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>36005000200</td>
      <td>2025-06-01</td>
      <td>8</td>
      <td>5</td>
      <td>5.0</td>
      <td>0.625</td>
    </tr>
    <tr>
      <th>4</th>
      <td>36005000200</td>
      <td>2025-06-02</td>
      <td>3</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>162339</th>
      <td>36085032300</td>
      <td>2025-08-15</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>162340</th>
      <td>36085032300</td>
      <td>2025-08-18</td>
      <td>2</td>
      <td>1</td>
      <td>1.0</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>162341</th>
      <td>36085032300</td>
      <td>2025-08-19</td>
      <td>4</td>
      <td>4</td>
      <td>4.0</td>
      <td>1.000</td>
    </tr>
    <tr>
      <th>162342</th>
      <td>36085032300</td>
      <td>2025-08-20</td>
      <td>2</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
    <tr>
      <th>162343</th>
      <td>36085032300</td>
      <td>2025-08-21</td>
      <td>1</td>
      <td>0</td>
      <td>0.0</td>
      <td>0.000</td>
    </tr>
  </tbody>
</table>
<p>162344 rows × 6 columns</p>
</div></div>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 10</summary>
        <pre class="cell-code"><code># Save point aggregated data joined_gdf with GEOID assignment.
point_cols = [
    &quot;unique_key&quot;, &quot;created_date&quot;, &quot;complaint_type&quot;, &quot;descriptor&quot;,
    &quot;latitude&quot;, &quot;longitude&quot;, &quot;borough&quot;, &quot;GEOID&quot;, 
    &quot;ct_norm&quot;, &quot;qol_flag&quot;, &quot;date&quot;, &quot;geometry&quot;
]

# Ensure only the necessary columns are kept and the index is dropped for clean output.
point_data_gdf = joined_gdf[point_cols].copy()

# Save GeoDataFrame to GeoJSON file.
point_data_gdf.to_file(point_path_geojson, driver = &quot;GeoJSON&quot;)

print(&quot;Saved point data as GeoJSON:&quot;, point_path_geojson)</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-stream">Saved point data as GeoJSON: data\nyc_311\nyc_311_points_2025.geojson
</pre>
</div>
</div>

    </div>
    
    <div class="notebook-nav-buttons notebook-nav-bottom">
        <a href="#" data-page="04b_code_heat_classification" class="notebook-prev">← 1b. Heat Classification</a>
        <a href="#" data-page="04d_code_census_acs" class="notebook-next">3. Census ACS →</a>
    </div>
</div>

<div class="content-right">
    <div class="panel-right-content">
        <h2>Notebooks</h2>
        <ul class="notebook-nav-list">
            <li class=""><a href="#" data-page="04a_code_weather_stations">1a. Weather Stations</a></li>
<li class=""><a href="#" data-page="04b_code_heat_classification">1b. Heat Classification</a></li>
<li class="notebook-nav-current"><a href="#" data-page="04c_code_311_processing">2. 311 Processing</a></li>
<li class=""><a href="#" data-page="04d_code_census_acs">3. Census ACS</a></li>
<li class=""><a href="#" data-page="04e_code_additional_features">4. Additional Features</a></li>
<li class=""><a href="#" data-page="04f_code_nlcd_rasters">5. NLCD Rasters</a></li>
<li class=""><a href="#" data-page="04g_code_data_merging">6. Data Merging</a></li>
<li class=""><a href="#" data-page="04h_code_eda">7. EDA</a></li>
<li class=""><a href="#" data-page="04i_code_ols_ml_shap">8. OLS & ML + SHAP</a></li>
        </ul>
        
        <h2>This Notebook</h2>
        <p><b>Source:</b> 02_311_tract_daily.ipynb</p>
        <p><b>Code Cells:</b> 10</p>
        <p><b>Figures:</b> 0</p>
    </div>
    <div class="panel-right-footer">
        <h3>Data Pipeline</h3>
        <h5>Weather → 311 → Census → Features → Merge → EDA → Modeling</h5>
    </div>
</div>