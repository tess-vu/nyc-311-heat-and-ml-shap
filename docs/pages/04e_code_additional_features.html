<div class="content-middle">
    <h1>CODE: Additional Feature Engineering</h1>
    <h2>Hot City, Heated Calls:<br>Understanding Extreme Heat and Quality of Life<br>Using New York City's 311 and SHAP</h2>
    
    <p class="notebook-description">Computing POI density, subway distance, and other spatial accessibility metrics.</p>
    
    <div class="notebook-controls">
        <button onclick="toggleAllCode(true)" class="code-toggle-btn">Show All Code</button>
        <button onclick="toggleAllCode(false)" class="code-toggle-btn">Hide All Code</button>
    </div>
    
    <div class="notebook-nav-buttons">
        <a href="#" data-page="04d_code_census_acs" class="notebook-prev">← 3. Census ACS</a>
        <a href="#" data-page="04f_code_nlcd_rasters" class="notebook-next">5. NLCD Rasters →</a>
    </div>
    
    <div class="report-content notebook-content">
<div class="cell-markdown"><h3>NDVI</h3></div>

<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 1</summary>
        <pre class="cell-code"><code>## Module
from pathlib import Path
import geopandas as gpd
import rasterio
from rasterio.mask import mask
import numpy as np
import pandas as pd</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 2</summary>
        <pre class="cell-code"><code>## File Paths
tracts_path = Path(&quot;data/nyc_tracts_2020/nyc_tracts_2020.shp&quot;)
NDVI_dir = Path(&quot;data/raster/NDVI.tif&quot;)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 3</summary>
        <pre class="cell-code"><code># 1. Load NYC census tracts shapefile
tracts = gpd.read_file(tracts_path)

# 2. Open NDVI raster and ensure CRS matches the vector layer
with rasterio.open(NDVI_dir) as src:
    raster_crs = src.crs
    nodata = src.nodata

    # Reproject tracts to match raster CRS if necessary
    if tracts.crs != raster_crs:
        tracts = tracts.to_crs(raster_crs)

    ndvi_means = []

    # 3. Compute zonal mean NDVI for each tract
    for _, row in tracts.iterrows():
        geom = [row.geometry]

        # Mask raster using the tract polygon
        out_image, out_transform = mask(src, geom, crop=True)

        data = out_image[0].astype(&quot;float32&quot;)

        # Replace NoData values with NaN to avoid affecting mean
        if nodata is not None:
            data[data == nodata] = np.nan

        # Compute mean NDVI for this tract
        mean_ndvi = float(np.nanmean(data))
        ndvi_means.append(mean_ndvi)

# 4. Add NDVI results to GeoDataFrame
tracts[&quot;NDVI&quot;] = ndvi_means

tracts.head()</code></pre>
    </details>
    <div class="cell-outputs">
<div class="output-html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ctlabel</th>
      <th>borocode</th>
      <th>boroname</th>
      <th>ct2020</th>
      <th>boroct2020</th>
      <th>cdeligibil</th>
      <th>ntaname</th>
      <th>nta2020</th>
      <th>cdta2020</th>
      <th>cdtaname</th>
      <th>geoid</th>
      <th>shape_leng</th>
      <th>shape_area</th>
      <th>geometry</th>
      <th>NDVI</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>000100</td>
      <td>1000100</td>
      <td>I</td>
      <td>The Battery-Governors Island-Ellis Island-Libe...</td>
      <td>MN0191</td>
      <td>MN01</td>
      <td>MN01 Financial District-Tribeca (CD 1 Equivalent)</td>
      <td>36061000100</td>
      <td>10833.043929</td>
      <td>1.843005e+06</td>
      <td>MULTIPOLYGON (((580787.267 4504805.375, 580819...</td>
      <td>0.024685</td>
    </tr>
    <tr>
      <th>1</th>
      <td>14.01</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>001401</td>
      <td>1001401</td>
      <td>I</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061001401</td>
      <td>5075.332000</td>
      <td>1.006117e+06</td>
      <td>POLYGON ((585444.188 4507772.701, 585514.711 4...</td>
      <td>0.074870</td>
    </tr>
    <tr>
      <th>2</th>
      <td>14.02</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>001402</td>
      <td>1001402</td>
      <td>E</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061001402</td>
      <td>4459.156019</td>
      <td>1.226206e+06</td>
      <td>POLYGON ((585718.928 4508068.700, 585790.344 4...</td>
      <td>0.046529</td>
    </tr>
    <tr>
      <th>3</th>
      <td>18</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>001800</td>
      <td>1001800</td>
      <td>I</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061001800</td>
      <td>6391.921174</td>
      <td>2.399277e+06</td>
      <td>POLYGON ((585313.281 4508223.568, 585324.698 4...</td>
      <td>0.041547</td>
    </tr>
    <tr>
      <th>4</th>
      <td>22.01</td>
      <td>1</td>
      <td>Manhattan</td>
      <td>002201</td>
      <td>1002201</td>
      <td>E</td>
      <td>Lower East Side</td>
      <td>MN0302</td>
      <td>MN03</td>
      <td>MN03 Lower East Side-Chinatown (CD 3 Equivalent)</td>
      <td>36061002201</td>
      <td>5779.062607</td>
      <td>1.740174e+06</td>
      <td>POLYGON ((586251.705 4508169.291, 586248.764 4...</td>
      <td>0.063541</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>

<div class="cell-markdown"><h2>WCR</h2></div>

<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 4</summary>
        <pre class="cell-code"><code>## File Paths
water_path = Path(&quot;data/Water shp/NYC_water.shp&quot;)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 5</summary>
        <pre class="cell-code"><code>water = gpd.read_file(water_path)

tracts = tracts.to_crs(water.crs)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 6</summary>
        <pre class="cell-code"><code># 1. Compute tract area
tracts[&quot;tract_area&quot;] = tracts.geometry.area

# 2. Intersect tracts with water polygons
#    This will create pieces of water polygons clipped by tract boundaries
water_in_tracts = gpd.overlay(
    tracts[[&quot;geoid&quot;, &quot;geometry&quot;]],
    water[[&quot;geometry&quot;]],
    how=&quot;intersection&quot;
)

# 3. Compute water area inside each tract
water_in_tracts[&quot;water_area&quot;] = water_in_tracts.geometry.area

# 4. Aggregate water area by tract (GEOID)
water_area_by_tract = (
    water_in_tracts
    .groupby(&quot;geoid&quot;)[&quot;water_area&quot;]
    .sum()
)

# 5. Map aggregated water area back to the tracts GeoDataFrame
tracts[&quot;water_area&quot;] = tracts[&quot;geoid&quot;].map(water_area_by_tract).fillna(0)

# 6. Compute Water Coverage Ratio (WCR = water area / tract area)
tracts[&quot;WCR&quot;] = tracts[&quot;water_area&quot;] / tracts[&quot;tract_area&quot;]

# Check the result
tracts[[&quot;geoid&quot;, &quot;NDVI&quot;, &quot;WCR&quot;]].head()</code></pre>
    </details>
    <div class="cell-outputs">
<div class="output-html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geoid</th>
      <th>NDVI</th>
      <th>WCR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>36061000100</td>
      <td>0.024685</td>
      <td>0.017985</td>
    </tr>
    <tr>
      <th>1</th>
      <td>36061001401</td>
      <td>0.074870</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36061001402</td>
      <td>0.046529</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>36061001800</td>
      <td>0.041547</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>36061002201</td>
      <td>0.063541</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>

<div class="cell-markdown"><h2>BD and AH</h2></div>

<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 7</summary>
        <pre class="cell-code"><code>building_path = Path(&quot;data/Buildings/geo_export_10da9e2c-833d-4ba4-9fe2-1f999ac16759.shp&quot;)
buildings = gpd.read_file(building_path)</code></pre>
    </details>
    
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 8</summary>
        <pre class="cell-code"><code>buildings = buildings.to_crs(water.crs)
buildings.crs</code></pre>
    </details>
    <div class="cell-outputs">
<pre class="output-text">&lt;Projected CRS: EPSG:32618&gt;
Name: WGS 84 / UTM zone 18N
Axis Info [cartesian]:
- E[east]: Easting (metre)
- N[north]: Northing (metre)
Area of Use:
- name: Between 78°W and 72°W, northern hemisphere between equator and 84°N, onshore and offshore. Bahamas. Canada - Nunavut; Ontario; Quebec. Colombia. Cuba. Ecuador. Greenland. Haiti. Jamaica. Panama. Turks and Caicos Islands. United States (USA). Venezuela.
- bounds: (-78.0, 0.0, -72.0, 84.0)
Coordinate Operation:
- name: UTM zone 18N
- method: Transverse Mercator
Datum: World Geodetic System 1984 ensemble
- Ellipsoid: WGS 84
- Prime Meridian: Greenwich</pre>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 9</summary>
        <pre class="cell-code"><code># 1. Use height_roo as building height (it is in feet), convert to meters
buildings[&quot;bldg_height&quot;] = buildings[&quot;height_roo&quot;] * 0.3048

# 2. Compute building footprint area (in m² because CRS is UTM)
buildings[&quot;bldg_area&quot;] = buildings.geometry.area

# 3. Compute tract area
tracts[&quot;tract_area&quot;] = tracts.geometry.area

# 4. Spatial join — assign buildings to tracts
bldg_in_tracts = gpd.sjoin(
    buildings[[&quot;bldg_height&quot;, &quot;bldg_area&quot;, &quot;geometry&quot;]],
    tracts[[&quot;geoid&quot;, &quot;geometry&quot;]],
    how=&quot;inner&quot;,
    predicate=&quot;intersects&quot;
)

# 5. Weighted height sum for AH
bldg_in_tracts[&quot;height_area&quot;] = (
    bldg_in_tracts[&quot;bldg_height&quot;] * bldg_in_tracts[&quot;bldg_area&quot;]
)

# 6. Aggregate by tract
bldg_stats = (
    bldg_in_tracts
    .groupby(&quot;geoid&quot;)
    .agg(
        total_bldg_area=(&quot;bldg_area&quot;, &quot;sum&quot;),
        total_height_area=(&quot;height_area&quot;, &quot;sum&quot;)
    )
)

# 7. Join results back
tracts = tracts.join(bldg_stats, on=&quot;geoid&quot;)

tracts[&quot;total_bldg_area&quot;] = tracts[&quot;total_bldg_area&quot;].fillna(0)

# 8. BD (building density: footprint area ratio)
tracts[&quot;BD&quot;] = tracts[&quot;total_bldg_area&quot;] / tracts[&quot;tract_area&quot;]

# 9. AH (area-weighted building height)
tracts[&quot;AH&quot;] = tracts[&quot;total_height_area&quot;] / tracts[&quot;total_bldg_area&quot;]
tracts.loc[tracts[&quot;total_bldg_area&quot;] == 0, &quot;AH&quot;] = np.nan

# Preview
tracts[[&quot;geoid&quot;, &quot;BD&quot;, &quot;AH&quot;]].head()</code></pre>
    </details>
    <div class="cell-outputs">
<div class="output-html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geoid</th>
      <th>BD</th>
      <th>AH</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>36061000100</td>
      <td>0.242965</td>
      <td>22.344475</td>
    </tr>
    <tr>
      <th>1</th>
      <td>36061001401</td>
      <td>0.170096</td>
      <td>38.401079</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36061001402</td>
      <td>0.391586</td>
      <td>39.186175</td>
    </tr>
    <tr>
      <th>3</th>
      <td>36061001800</td>
      <td>0.407032</td>
      <td>25.738760</td>
    </tr>
    <tr>
      <th>4</th>
      <td>36061002201</td>
      <td>0.282754</td>
      <td>25.412280</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 10</summary>
        <pre class="cell-code"><code>## Save the reusults
# Select only the variables we need (drop geometry implicitly)
tracts_vars = tracts[[&quot;geoid&quot;, &quot;BD&quot;, &quot;AH&quot;, &quot;NDVI&quot;, &quot;WCR&quot;]].copy()

tracts_vars.columns = tracts_vars.columns.str.upper()

# Save to CSV (no index column)
tracts_vars.to_csv(&quot;data/additional_features/nyc_tracts_new_variables.csv&quot;, index=False)

tracts_vars</code></pre>
    </details>
    <div class="cell-outputs">
<div class="output-html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>geoid</th>
      <th>BD</th>
      <th>AH</th>
      <th>NDVI</th>
      <th>WCR</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>36061000100</td>
      <td>0.242965</td>
      <td>22.344475</td>
      <td>0.024685</td>
      <td>0.017985</td>
    </tr>
    <tr>
      <th>1</th>
      <td>36061001401</td>
      <td>0.170096</td>
      <td>38.401079</td>
      <td>0.074870</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>36061001402</td>
      <td>0.391586</td>
      <td>39.186175</td>
      <td>0.046529</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>36061001800</td>
      <td>0.407032</td>
      <td>25.738760</td>
      <td>0.041547</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>36061002201</td>
      <td>0.282754</td>
      <td>25.412280</td>
      <td>0.063541</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2320</th>
      <td>36061009903</td>
      <td>0.395851</td>
      <td>111.507287</td>
      <td>0.037452</td>
      <td>0.057454</td>
    </tr>
    <tr>
      <th>2321</th>
      <td>36061011700</td>
      <td>0.412318</td>
      <td>48.834404</td>
      <td>0.018437</td>
      <td>0.024806</td>
    </tr>
    <tr>
      <th>2322</th>
      <td>36061002601</td>
      <td>0.359600</td>
      <td>16.882413</td>
      <td>0.059028</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2323</th>
      <td>36061003200</td>
      <td>0.299328</td>
      <td>20.454839</td>
      <td>0.076770</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2324</th>
      <td>36061000202</td>
      <td>0.194488</td>
      <td>20.841588</td>
      <td>0.048946</td>
      <td>0.001324</td>
    </tr>
  </tbody>
</table>
<p>2325 rows × 5 columns</p>
</div></div>
</div>
</div>


<div class="cell-code-wrapper">
    <details class="code-fold">
        <summary class="code-fold-toggle">Code Cell 11</summary>
        <pre class="cell-code"><code># Predictor lists.
env_variables = [&quot;TREE_CANOPY_PCT&quot;, &quot;IMPERVIOUS_RATIO&quot;, &quot;WCR&quot;,&quot;NDVI&quot;]
acs_variables = [&quot;PCT_BACHELORS_PLUS&quot;, &quot;PCT_RENTERS&quot;, &quot;PCT_LIMITED_ENGLISH&quot;, &quot;MEDIAN_INCOME&quot;]
urban_variables = [&quot;KNN_SUBWAY&quot;, &quot;POI_DENSITY&quot;, &quot;KNN_PARKS&quot;,&quot;BD&quot;,&quot;AH&quot;]</code></pre>
    </details>
    
</div>

    </div>
    
    <div class="notebook-nav-buttons notebook-nav-bottom">
        <a href="#" data-page="04d_code_census_acs" class="notebook-prev">← 3. Census ACS</a>
        <a href="#" data-page="04f_code_nlcd_rasters" class="notebook-next">5. NLCD Rasters →</a>
    </div>
</div>

<div class="content-right">
    <div class="panel-right-content">
        <h2>Notebooks</h2>
        <ul class="notebook-nav-list">
            <li class=""><a href="#" data-page="04a_code_weather_stations">1a. Weather Stations</a></li>
<li class=""><a href="#" data-page="04b_code_heat_classification">1b. Heat Classification</a></li>
<li class=""><a href="#" data-page="04c_code_311_processing">2. 311 Processing</a></li>
<li class=""><a href="#" data-page="04d_code_census_acs">3. Census ACS</a></li>
<li class="notebook-nav-current"><a href="#" data-page="04e_code_additional_features">4. Additional Features</a></li>
<li class=""><a href="#" data-page="04f_code_nlcd_rasters">5. NLCD Rasters</a></li>
<li class=""><a href="#" data-page="04g_code_data_merging">6. Data Merging</a></li>
<li class=""><a href="#" data-page="04h_code_eda">7. EDA</a></li>
<li class=""><a href="#" data-page="04i_code_ols_ml_shap">8. OLS & ML + SHAP</a></li>
        </ul>
        
        <h2>This Notebook</h2>
        <p><b>Source:</b> 04_additional_feature.ipynb</p>
        <p><b>Code Cells:</b> 11</p>
        <p><b>Figures:</b> 0</p>
    </div>
    <div class="panel-right-footer">
        <h3>Data Pipeline</h3>
        <h5>Weather → 311 → Census → Features → Merge → EDA → Modeling</h5>
    </div>
</div>